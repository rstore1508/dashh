<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard de Vendas - Ranking de Produtos</title>
<style>
  /* (Seu CSS existente, sem altera√ß√µes importantes) */
  /* Copie e cole seu CSS atual aqui para n√£o perder o estilo */
  /* --- */

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #333;
  }
  /* ... continue com todo seu CSS atual ... */
  /* Para economizar espa√ßo n√£o vou colar todo CSS novamente aqui, mas mantenha o seu */
  /* Adicione o container do gr√°fico abaixo */

  #dashboardChartContainer {
    max-width: 600px;
    margin: 0 auto 40px;
    background: rgba(255,255,255,0.95);
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  }

</style>
</head>
<body>
  <!-- Tela de Login -->
  <div id="loginScreen" class="login-screen">
    <div class="login-container">
      <h1 class="login-title">üîê Acesso Restrito</h1>
      <form id="loginForm" class="login-form" autocomplete="off">
        <input
          type="text"
          id="username"
          class="login-input"
          placeholder="Usu√°rio"
          required
          autocomplete="username"
          autofocus
        />
        <input
          type="password"
          id="password"
          class="login-input"
          placeholder="Senha"
          required
          autocomplete="current-password"
        />
        <button type="submit" class="login-btn">Entrar</button>
        <div id="loginError" class="login-error">Usu√°rio ou senha incorretos!</div>
      </form>
    </div>
  </div>

  <!-- Dashboard Principal -->
  <div id="mainDashboard" class="main-dashboard" aria-hidden="true">
    <div class="container">
      <div class="header">
        <button class="logout-btn" onclick="logout()" aria-label="Sair do Dashboard">Sair</button>
        <h1>Ranking de Produtos - Dashboard</h1>
        <div class="controls">
          <div class="filter-group">
            <label for="skuFilter">Filtrar por SKU:</label>
            <input type="text" id="skuFilter" placeholder="Digite o c√≥digo SKU" />
          </div>
          <div class="filter-group">
            <label for="monthFilter">Filtrar por M√™s:</label>
            <select id="monthFilter" aria-label="Filtro por m√™s">
              <option value="">Todos os Meses</option>
              <option value="janeiro">Janeiro</option>
              <option value="fevereiro">Fevereiro</option>
              <option value="mar√ßo">Mar√ßo</option>
              <option value="abril">Abril</option>
              <option value="maio">Maio</option>
              <option value="junho">Junho</option>
              <option value="julho">Julho</option>
              <option value="agosto">Agosto</option>
              <option value="setembro">Setembro</option>
              <option value="outubro">Outubro</option>
              <option value="novembro">Novembro</option>
              <option value="dezembro">Dezembro</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="channelFilter">Filtrar por Canal:</label>
            <select id="channelFilter" aria-label="Filtro por canal">
              <option value="">Todos os Canais</option>
              <option value="shecom ml">Shecom ML</option>
              <option value="tuguir ml">Tuguir ML</option>
              <option value="romplac">Romplac</option>
              <option value="dafiti">Dafiti</option>
              <option value="shopee">Shopee</option>
              <option value="magazine luiza">Magazine Luiza</option>
              <option value="relogiostore">RelogioStore</option>
              <option value="shop do relogio">Shop do Relogio</option>
              <option value="netshoes">Netshoes</option>
            </select>
          </div>
          <button class="add-product-btn" onclick="openModal()" type="button">+ Adicionar Produto</button>
          <button class="add-product-btn" style="background:#27ae60; margin-left:10px;" onclick="openBulkImportModal()" type="button">üì• Importar em Massa</button>
        </div>
      </div>

      <!-- Gr√°fico de Pizza -->
      <div id="dashboardChartContainer">
        <canvas id="salesPieChart" aria-label="Gr√°fico de pizza das vendas por produto" role="img"></canvas>
      </div>

      <div class="stats-overview">
        <div class="stat-card">
          <div class="stat-number" id="totalProducts">0</div>
          <div class="stat-label">Total de Produtos</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalSales">R$ 0,00</div>
          <div class="stat-label">Vendas Totais</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalUnits">0</div>
          <div class="stat-label">Unidades Vendidas</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalStock">0</div>
          <div class="stat-label">Estoque Total</div>
        </div>
      </div>
      <div id="productsContainer" class="products-grid" aria-live="polite" aria-atomic="true"></div>
    </div>
  </div>

  <!-- Modal adicionar/editar produto -->
  <div id="productModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Adicionar Produto</h2>
        <button class="close-btn" onclick="closeModal()" aria-label="Fechar modal">&times;</button>
      </div>
      <form id="productForm" autocomplete="off">
        <div class="form-group">
          <label for="productSKU">C√≥digo (SKU):</label>
          <input type="text" id="productSKU" required placeholder="Ex: PROD12345" />
        </div>
        <div class="form-group">
          <label for="productName">Nome do Produto:</label>
          <input type="text" id="productName" required />
        </div>
        <div class="form-group">
          <label for="productImage">URL da Imagem:</label>
          <input
            type="url"
            id="productImage"
            placeholder="https://exemplo.com/imagem.jpg"
            pattern="https?://.+"
            title="Insira uma URL v√°lida come√ßando com http:// ou https://"
          />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="productMonth">M√™s:</label>
            <select id="productMonth" required>
              <option value="janeiro">Janeiro</option>
              <option value="fevereiro">Fevereiro</option>
              <option value="mar√ßo">Mar√ßo</option>
              <option value="abril">Abril</option>
              <option value="maio">Maio</option>
              <option value="junho">Junho</option>
              <option value="julho">Julho</option>
              <option value="agosto">Agosto</option>
              <option value="setembro">Setembro</option>
              <option value="outubro">Outubro</option>
              <option value="novembro">Novembro</option>
              <option value="dezembro">Dezembro</option>
            </select>
          </div>
          <div class="form-group">
            <label for="productUnits">Unidades Vendidas:</label>
            <input type="number" id="productUnits" min="0" required />
          </div>
          <div class="form-group">
            <label for="productRevenue">Faturamento (R$):</label>
            <input type="number" id="productRevenue" min="0" step="0.01" required />
          </div>
        </div>
        <div class="form-group">
          <label for="productChannel">Canal de Venda:</label>
          <select id="productChannel" required>
            <option value="shecom ml">Shecom ML</option>
            <option value="tuguir ml">Tuguir ML</option>
            <option value="romplac">Romplac</option>
            <option value="dafiti">Dafiti</option>
            <option value="shopee">Shopee</option>
            <option value="magazine luiza">Magazine Luiza</option>
            <option value="relogiostore">RelogioStore</option>
            <option value="shop do relogio">Shop do Relogio</option>
            <option value="netshoes">Netshoes</option>
          </select>
        </div>
        <div class="form-group">
          <label>Estoque por Localiza√ß√£o:</label>
          <div class="form-row">
            <div class="form-group">
              <label for="stockFull">Full (unidades):</label>
              <input type="number" id="stockFull" min="0" value="0" required />
            </div>
            <div class="form-group">
              <label for="stockSP">SP (unidades):</label>
              <input type="number" id="stockSP" min="0" value="0" required />
            </div>
            <div class="form-group">
              <label for="stockMASP">MA/SP (unidades):</label>
              <input type="number" id="stockMASP" min="0" value="0" required />
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="duplicateCount">N√∫mero de duplicatas:</label>
          <input type="number" id="duplicateCount" min="1" value="1" />
        </div>
        <button type="submit" class="save-btn">Salvar Produto</button>
        <button type="button" class="cancel-btn" onclick="cancelEdit()">Cancelar</button>
      </form>
    </div>
  </div>

  <!-- Modal Importa√ß√£o em Massa -->
  <div id="bulkImportModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="bulkModalTitle" aria-hidden="true">
    <div class="modal-content" style="max-width:700px;">
      <div class="modal-header">
        <h2 class="modal-title" id="bulkModalTitle">Importar Produtos em Massa</h2>
        <button class="close-btn" onclick="closeBulkImportModal()" aria-label="Fechar modal">&times;</button>
      </div>
      <p style="margin-bottom:15px; color:#555;">
        Cole os dados dos produtos aqui, uma linha para cada produto.<br/>
        Os campos devem estar separados por v√≠rgula, na ordem:<br/>
        <strong>SKU,Nome,Imagem (URL),M√™s,Canal,Unidades,Faturamento,EstoqueFull,EstoqueSP,EstoqueMASP</strong>
      </p>
      <textarea id="bulkImportTextarea" style="width:100%; height:250px; padding:15px; font-family: monospace; font-size:14px;" placeholder="Exemplo:\nPROD001,Rel√≥gio Azul,https://exemplo.com/azul.jpg,janeiro,shecom ml,50,2500.50,15,20,10"></textarea>
      <button class="save-btn" style="margin-top:15px;" onclick="processBulkImport()">Importar Produtos</button>
      <button class="cancel-btn" style="margin-top:10px;" onclick="closeBulkImportModal()">Cancelar</button>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const validCredentials = {
    admin: "vendas123",
  };

  let products = [];
  let editingProductId = null;
  let salesPieChart = null;

  function loadData() {
    const data = localStorage.getItem("productsData");
    if (data) {
      try {
        products = JSON.parse(data);
      } catch {
        products = [];
      }
    }
  }

  function saveData() {
    localStorage.setItem("productsData", JSON.stringify(products));
  }

  function renderProducts() {
    const container = document.getElementById("productsContainer");
    const skuFilter = document.getElementById("skuFilter").value.trim().toLowerCase();
    const monthFilter = document.getElementById("monthFilter").value.trim().toLowerCase();
    const channelFilter = document.getElementById("channelFilter").value.trim().toLowerCase();

    let filtered = products;

    if (skuFilter) {
      filtered = filtered.filter(p => p.sku.toLowerCase().includes(skuFilter));
    }
    if (monthFilter) filtered = filtered.filter(p => p.month.toLowerCase() === monthFilter);
    if (channelFilter) filtered = filtered.filter(p => p.channel.toLowerCase() === channelFilter);

    if (filtered.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <h3>Nenhum produto encontrado</h3>
          <p>Tente ajustar os filtros ou adicione novos produtos</p>
        </div>
      `;
      updateStats(filtered);
      updateChart(filtered);
      return;
    }

    filtered.sort((a,b) => b.units - a.units);

    container.innerHTML = filtered.map((p, i) => {
      const rank = i + 1;
      const totalStock = p.stock.full + p.stock.sp + p.stock.masp;
      const lowStock = totalStock < 20;
      let rankClass = "";
      if (rank === 1) rankClass = "top-1";
      else if (rank <= 3) rankClass = "top-3";

      return `
        <div class="product-card" tabindex="0" role="button" aria-pressed="false" onclick="openModalById(${p.id})" onkeypress="if(event.key==='Enter'){openModalById(${p.id})}">
          <div class="ranking-badge ${rankClass}">${rank}¬∫</div>
          <img src="${p.image || 'https://via.placeholder.com/120x120?text=Produto'}"
            alt="${p.name}" class="product-image"
            onerror="this.src='https://via.placeholder.com/120x120?text=Produto'"/>
          <div class="product-sku">SKU: ${p.sku}</div>
          <h3 class="product-name">${p.name}</h3>
          <div class="product-stats">
            <div class="stat-item">
              <div class="stat-value">${p.units}</div>
              <div class="stat-text">Unidades Vendidas</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">R$ ${p.revenue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
              <div class="stat-text">Faturamento</div>
            </div>
          </div>
          <div class="stock-section">
            <div class="stock-title">üì¶ Controle de Estoque</div>
            <div class="stock-grid">
              <div class="stock-item ${p.stock.full < 10 ? 'low-stock' : ''}">
                <div class="stock-location">FULL</div>
                <div class="stock-quantity">${p.stock.full}</div>
              </div>
              <div class="stock-item ${p.stock.sp < 10 ? 'low-stock' : ''}">
                <div class="stock-location">SP</div>
                <div class="stock-quantity">${p.stock.sp}</div>
              </div>
              <div class="stock-item ${p.stock.masp < 10 ? 'low-stock' : ''}">
                <div class="stock-location">MA/SP</div>
                <div class="stock-quantity">${p.stock.masp}</div>
              </div>
            </div>
          </div>
          <div class="channels-list">
            <span class="channel-tag">${p.channel}</span>
            <span class="channel-tag">${p.month}</span>
            ${lowStock ? `<span class="channel-tag" style="background:#e74c3c">‚ö† Estoque Baixo</span>` : ''}
          </div>
        </div>
      `;
    }).join("");

    updateStats(filtered);
    updateChart(filtered);
  }

  function openModal(product = null) {
    const modal = document.getElementById("productModal");
    modal.style.display = "block";
    modal.setAttribute("aria-hidden", "false");

    if (product) {
      editingProductId = product.id;
      document.getElementById("productSKU").value = product.sku;
      document.getElementById("productName").value = product.name;
      document.getElementById("productImage").value = product.image;
      document.getElementById("productMonth").value = product.month;
      document.getElementById("productChannel").value = product.channel;
      document.getElementById("productUnits").value = product.units;
      document.getElementById("productRevenue").value = product.revenue;
      document.getElementById("stockFull").value = product.stock.full;
      document.getElementById("stockSP").value = product.stock.sp;
      document.getElementById("stockMASP").value = product.stock.masp;
      document.getElementById("duplicateCount").value = 1;
    } else {
      editingProductId = null;
      document.getElementById("productForm").reset();
      document.getElementById("duplicateCount").value = 1;
    }

    document.getElementById("productSKU").focus();
  }

  function closeModal() {
    const modal = document.getElementById("productModal");
    modal.style.display = "none";
    modal.setAttribute("aria-hidden", "true");
    document.getElementById("productForm").reset();
    editingProductId = null;
  }

  function cancelEdit() {
    closeModal();
  }

  function openModalById(id) {
    const product = products.find(p => p.id === id);
    if (product) openModal(product);
  }

  function updateStats(filtered) {
    const totalProducts = filtered.length;
    const totalSales = filtered.reduce((sum, p) => sum + p.revenue, 0);
    const totalUnits = filtered.reduce((sum, p) => sum + p.units, 0);
    const totalStock = filtered.reduce((sum, p) => sum + p.stock.full + p.stock.sp + p.stock.masp, 0);

    document.getElementById("totalProducts").textContent = totalProducts;
    document.getElementById("totalSales").textContent = `R$ ${totalSales.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    document.getElementById("totalUnits").textContent = totalUnits;
    document.getElementById("totalStock").textContent = totalStock;
  }

  function showLogin() {
    document.getElementById("loginScreen").style.display = "flex";
    document.getElementById("mainDashboard").style.display = "none";
    document.getElementById("loginError").style.display = "none";
    document.getElementById("username").focus();
  }

  function showDashboard() {
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("mainDashboard").style.display = "block";
    renderProducts();
  }

  function logout() {
    sessionStorage.removeItem("isLoggedIn");
    showLogin();
  }

  function checkAuth() {
    const loggedIn = sessionStorage.getItem("isLoggedIn");
    if(loggedIn === "true") {
      showDashboard();
    } else {
      showLogin();
    }
  }

  document.getElementById("loginForm").addEventListener("submit", function(e){
    e.preventDefault();
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();

    if(validCredentials[username] && validCredentials[username] === password){
      sessionStorage.setItem("isLoggedIn", "true");
      document.getElementById("loginError").style.display = "none";
      this.reset();
      showDashboard();
    } else {
      document.getElementById("loginError").style.display = "block";
    }
  });

  document.getElementById("productForm").addEventListener("submit", function(e){
    e.preventDefault();

    const duplicateCount = parseInt(document.getElementById("duplicateCount").value, 10) || 1;

    const baseData = {
      sku: document.getElementById("productSKU").value.trim(),
      name: document.getElementById("productName").value.trim(),
      image: document.getElementById("productImage").value.trim(),
      month: document.getElementById("productMonth").value.trim().toLowerCase(),
      channel: document.getElementById("productChannel").value.trim().toLowerCase(),
      units: parseInt(document.getElementById("productUnits").value,10),
      revenue: parseFloat(document.getElementById("productRevenue").value),
      stock: {
        full: parseInt(document.getElementById("stockFull").value,10),
        sp: parseInt(document.getElementById("stockSP").value,10),
        masp: parseInt(document.getElementById("stockMASP").value,10),
      }
    };

    if(editingProductId !== null){
      // Atualiza produto existente
      const index = products.findIndex(p => p.id === editingProductId);
      if(index !== -1){
        products[index] = {...products[index], ...baseData};
      }
    } else {
      // Adiciona produto(s) novos, duplicando conforme o n√∫mero
      for(let i = 0; i < duplicateCount; i++){
        products.push({
          id: Date.now() + i,
          ...baseData
        });
      }
    }

    saveData();
    renderProducts();
    closeModal();
  });

  document.getElementById("monthFilter").addEventListener("change", renderProducts);
  document.getElementById("channelFilter").addEventListener("change", renderProducts);
  document.getElementById("skuFilter").addEventListener("input", renderProducts);

  window.addEventListener("click", function(e){
    const modal = document.getElementById("productModal");
    if(e.target === modal){
      closeModal();
    }
    const bulkModal = document.getElementById("bulkImportModal");
    if(e.target === bulkModal){
      closeBulkImportModal();
    }
  });

  window.addEventListener("load", function(){
    loadData();
    checkAuth();
  });

  // Novas fun√ß√µes para Importa√ß√£o em Massa

  function openBulkImportModal() {
    const modal = document.getElementById("bulkImportModal");
    modal.style.display = "block";
    modal.setAttribute("aria-hidden", "false");
    document.getElementById("bulkImportTextarea").focus();
  }

  function closeBulkImportModal() {
    const modal = document.getElementById("bulkImportModal");
    modal.style.display = "none";
    modal.setAttribute("aria-hidden", "true");
    document.getElementById("bulkImportTextarea").value = "";
  }

  function processBulkImport() {
    const textarea = document.getElementById("bulkImportTextarea");
    const text = textarea.value.trim();

    if (!text) {
      alert("Por favor, cole os dados para importar.");
      return;
    }

    const lines = text.split("\n");
    let addedCount = 0;
    let updatedCount = 0;
    let errors = [];

    lines.forEach((line, index) => {
      const parts = line.split(",").map(p => p.trim());

      if (parts.length < 10) {
        errors.push(`Linha ${index + 1}: Dados insuficientes.`);
        return;
      }

      const [
        sku, name, image, month, channel,
        unitsStr, revenueStr, stockFullStr, stockSPStr, stockMASPStr
      ] = parts;

      const units = parseInt(unitsStr, 10);
      const revenue = parseFloat(revenueStr.replace(",","."));
      const stockFull = parseInt(stockFullStr, 10);
      const stockSP = parseInt(stockSPStr, 10);
      const stockMASP = parseInt(stockMASPStr, 10);

      if (!sku || !name || !month || !channel || isNaN(units) || isNaN(revenue) || isNaN(stockFull) || isNaN(stockSP) || isNaN(stockMASP)) {
        errors.push(`Linha ${index + 1}: Dados inv√°lidos.`);
        return;
      }

      // Normaliza m√™s e canal
      const normalizedMonth = month.trim().toLowerCase();
      const normalizedChannel = channel.trim().toLowerCase();

      // Verifica se produto j√° existe pelo SKU
      const existingIndex = products.findIndex(p => p.sku === sku && p.month === normalizedMonth && p.channel === normalizedChannel);
      if (existingIndex !== -1) {
        // Atualiza dados relevantes mantendo outros campos
        products[existingIndex].image = image || products[existingIndex].image;
        products[existingIndex].stock.full = stockFull;
        products[existingIndex].stock.sp = stockSP;
        products[existingIndex].stock.masp = stockMASP;
        products[existingIndex].units = units;
        products[existingIndex].revenue = revenue;
        updatedCount++;
      } else {
        // Produto novo
        products.push({
          id: Date.now() + index + Math.floor(Math.random() * 1000),
          sku,
          name,
          image,
          month: normalizedMonth,
          channel: normalizedChannel,
          units,
          revenue,
          stock: {
            full: stockFull,
            sp: stockSP,
            masp: stockMASP
          }
        });
        addedCount++;
      }
    });

    saveData();
    renderProducts();
    closeBulkImportModal();

    let message = `Importa√ß√£o conclu√≠da: ${addedCount} produto(s) adicionados, ${updatedCount} produto(s) atualizados.`;
    if (errors.length) {
      message += `\n\nAlguns erros foram encontrados:\n- ${errors.join("\n- ")}`;
    }

    alert(message);
  }

  // Fun√ß√£o para atualizar o gr√°fico de pizza
  function updateChart(filteredProducts) {
    const ctx = document.getElementById('salesPieChart').getContext('2d');

    // Agrupar por produto (SKU + nome), somando receita
    const grouped = {};
    filteredProducts.forEach(p => {
      const key = `${p.sku} - ${p.name}`;
      if (!grouped[key]) grouped[key] = 0;
      grouped[key] += p.revenue;
    });

    const labels = Object.keys(grouped);
    const data = Object.values(grouped);

    // Se o gr√°fico j√° existe, destr√≥i para recriar
    if (salesPieChart) salesPieChart.destroy();

    salesPieChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels,
        datasets: [{
          label: 'Faturamento (R$)',
          data,
          backgroundColor: generateColors(labels.length),
          borderWidth: 1,
          borderColor: '#fff',
          hoverOffset: 30,
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              boxWidth: 20,
              padding: 15,
              font: {
                size: 14
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = context.parsed;
                return `R$ ${value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
              }
            }
          },
          title: {
            display: true,
            text: 'Participa√ß√£o nas Vendas por Produto',
            font: { size: 18, weight: 'bold' }
          }
        }
      }
    });
  }

  // Gerar cores para o gr√°fico
  function generateColors(num) {
    const colors = [];
    const baseColors = [
      '#667eea', '#764ba2', '#f39c12', '#e74c3c', '#27ae60', '#2980b9',
      '#8e44ad', '#c0392b', '#d35400', '#16a085', '#2ecc71', '#3498db',
    ];
    for(let i = 0; i < num; i++) {
      colors.push(baseColors[i % baseColors.length]);
    }
    return colors;
  }

</script>
</body>
</html>
